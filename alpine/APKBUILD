# Contributor: Kalle M. Aagaard <alpine@k-moeller.dk>
# Maintainer: Kalle M. Aagaard <alpine@k-moeller.dk>
pkgname=acmednsproxy
pkgver=0.0.47
pkgrel=1
pkgdesc="A small certmgr service"
url="https://github.com/KalleDK/${pkgname}/"
arch="all"
license="MIT"
commit=${ADP_COMMIT}
source="${pkgname}-${commit}.tar.gz::https://github.com/KalleDK/${pkgname}/archive/${commit}.tar.gz
        ${pkgname}.initd
        ${pkgname}.confd
        "
builddir="${srcdir}/${pkgname}-${commit}/bin"
makedepends="git go"
subpackages="$pkgname-tools $pkgname-openrc"

check() {
    true
}

build() {
    git config --global --add safe.directory /github/workspace
    echo ${srcdir}
    cd ${srcdir}/${pkgname}-${commit}
    go build -v -ldflags=" \
        -X 'github.com/KalleDK/acmednsproxy/cmd/acmednsproxy/cmd.defaultAuthFile=/etc/acmednsproxy/auth.yaml' \
        -X 'github.com/KalleDK/acmednsproxy/cmd/acmednsproxy/cmd.defaultProviderFile=/etc/acmednsproxy/providers.yaml' \
    " -o ${builddir}/${pkgname} ./cmd/${pkgname}
    go build -v -o ${builddir}/adpcrypt ./cmd/adpcrypt
}

package() {
    # Binaries
    install -Dm755 "${builddir}/${pkgname}"   "${pkgdir}/usr/bin/${pkgname}"
    install -Dm755 "${builddir}/adpcrypt"      "${pkgdir}/usr/bin/adpcrypt"

    # Default configs
    install -Dm640 "${srcdir}/${pkgname}-${commit}/config/auth.yaml.example"      "${pkgdir}/etc/${pkgname}/auth.yaml.example"
    install -Dm640 "${srcdir}/${pkgname}-${commit}/config/providers.yaml.example" "${pkgdir}/etc/${pkgname}/providers.yaml.example"

    # Openrc
    install -Dm755 "${srcdir}/${pkgname}.initd" "${pkgdir}/etc/init.d/${pkgname}"
    install -Dm644 "${srcdir}/${pkgname}.confd" "${pkgdir}/etc/conf.d/${pkgname}"

    install -dm755 "${pkgdir}/var/log/${pkgname}"
}


tools() {
    amove usr/bin/adpcrypt
}